<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Book Indodax - Hyper Speed v3.3</title>
    
    <link rel="dns-prefetch" href="//indodax.com">
    <link rel="dns-prefetch" href="//corsproxy.io">
    <link rel="preconnect" href="https://indodax.com" crossorigin>
    <link rel="preconnect" href="https://corsproxy.io" crossorigin>
    
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--bg:#0a0a12;--card:#12121f;--border:#1e1e32;--text:#e0e0e0;--muted:#666;--buy:#00ff88;--sell:#ff4466;--accent:#00d4ff;--warning:#ffaa00}
        html{-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:8px;font-size:13px}
        
        .gpu{transform:translateZ(0);will-change:transform;backface-visibility:hidden}
        
        .header{text-align:center;padding:10px 0;position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--border)}
        .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--buy));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-flex;align-items:center;gap:8px}
        .badge{font-size:9px;padding:2px 6px;background:var(--accent);color:#000;border-radius:10px;font-weight:700;animation:pulse 2s infinite;-webkit-text-fill-color:#000}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        .speed-indicator{display:flex;justify-content:center;gap:15px;margin-top:8px;font-size:10px;color:var(--muted)}
        .speed-indicator span{display:flex;align-items:center;gap:4px}
        .dot{width:6px;height:6px;border-radius:50%;background:var(--buy);animation:blink 1s infinite}
        .dot.slow{background:var(--warning)}
        .dot.error{background:var(--sell);animation:none}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        
        .controls{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:8px;padding:10px;background:var(--card);border-radius:10px;margin:10px 0}
        
        .select-wrap{position:relative;min-width:280px}
        .select-display{width:100%;padding:10px 35px 10px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:13px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s}
        .select-display:hover{border-color:var(--accent)}
        .select-display.open{border-color:var(--accent);border-radius:6px 6px 0 0}
        .select-display::after{content:'‚ñº';position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--muted);transition:transform .2s}
        .select-display.open::after{transform:translateY(-50%) rotate(180deg)}
        .select-icon{font-size:16px}
        .select-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .select-pair{font-size:10px;color:var(--accent);background:rgba(0,212,255,.1);padding:2px 6px;border-radius:4px}
        
        .search-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--accent);border-top:none;border-radius:0 0 6px 6px;display:none;z-index:1000;box-shadow:0 10px 40px rgba(0,0,0,.5)}
        .search-dropdown.show{display:block}
        .search-input-wrap{position:relative;border-bottom:1px solid var(--border)}
        .search-input-wrap::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px}
        .search-input{width:100%;padding:12px 12px 12px 38px;border:none;background:var(--bg);color:var(--text);font-size:13px;outline:none}
        .search-input::placeholder{color:var(--muted)}
        .search-options{max-height:280px;overflow-y:auto}
        .search-options::-webkit-scrollbar{width:4px}
        .search-options::-webkit-scrollbar-track{background:var(--bg)}
        .search-options::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        .search-option{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background .1s;border-bottom:1px solid rgba(255,255,255,.02)}
        .search-option:hover{background:rgba(0,212,255,.1)}
        .search-option.selected{background:rgba(0,212,255,.15)}
        .search-option.hidden{display:none}
        .option-icon{font-size:18px;width:24px;text-align:center}
        .option-info{flex:1;min-width:0}
        .option-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .option-pair{font-size:10px;color:var(--muted);margin-top:2px}
        .option-check{color:var(--accent);font-size:14px;opacity:0}
        .search-option.selected .option-check{opacity:1}
        .no-result{padding:20px;text-align:center;color:var(--muted);display:none}
        .no-result.show{display:block}
        .search-stats{padding:8px 12px;background:rgba(0,0,0,.2);font-size:10px;color:var(--muted);display:flex;justify-content:space-between}
        
        .btn{padding:10px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .15s;font-size:12px}
        .btn-primary{background:var(--accent);color:#000}
        .btn-primary:hover{filter:brightness(1.2);transform:scale(1.02)}
        .btn-primary:active{transform:scale(.98)}
        .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
        .btn-sm{padding:6px 14px;font-size:11px;background:rgba(255,255,255,.1);color:var(--text)}
        .btn-sm:hover{background:rgba(255,255,255,.15)}
        .status-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:6px}
        .status-badge.loading{background:rgba(255,170,0,.15);color:var(--warning)}
        .status-badge.success{background:rgba(0,255,136,.15);color:var(--buy)}
        .status-badge.error{background:rgba(255,68,102,.15);color:var(--sell)}
        .spinner{width:10px;height:10px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .price-bar{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;padding:12px 15px;background:linear-gradient(135deg,rgba(0,255,136,.05),rgba(255,68,102,.05));border-radius:10px;margin-bottom:10px;align-items:center}
        .price-item{text-align:center}
        .price-item:first-child{text-align:left}
        .price-item:last-child{text-align:right}
        .price-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
        .price-value{font-size:18px;font-weight:700;font-family:'SF Mono',Consolas,monospace;margin-top:2px}
        .price-value.buy{color:var(--buy)}
        .price-value.sell{color:var(--sell)}
        .price-value.spread{color:var(--warning);font-size:14px}
        
        .tables{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:10px}
        .table-card{background:var(--card);border-radius:10px;border:1px solid var(--border);overflow:hidden;contain:layout style paint}
        .table-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:2px solid}
        .table-card.buy .table-header{border-color:var(--buy)}
        .table-card.sell .table-header{border-color:var(--sell)}
        .table-title{font-weight:700;font-size:13px;display:flex;align-items:center;gap:6px}
        .table-card.buy .table-title{color:var(--buy)}
        .table-card.sell .table-title{color:var(--sell)}
        .header-right{display:flex;align-items:center;gap:8px}
        .count-badge{font-size:11px;padding:3px 10px;border-radius:12px;font-weight:600}
        .table-card.buy .count-badge{background:rgba(0,255,136,.1);color:var(--buy)}
        .table-card.sell .count-badge{background:rgba(255,68,102,.1);color:var(--sell)}
        
        .table-scroll{height:400px;overflow-y:auto;overflow-x:hidden;contain:strict}
        .table-scroll.expanded{height:auto;max-height:600px}
        .table-scroll::-webkit-scrollbar{width:4px}
        .table-scroll::-webkit-scrollbar-track{background:var(--bg)}
        .table-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
        
        table{width:100%;border-collapse:collapse;table-layout:fixed}
        th{position:sticky;top:0;background:var(--bg);padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:600;text-align:right;z-index:1}
        th:first-child{width:35px;text-align:center}
        td{padding:5px 10px;font-size:12px;text-align:right;border-bottom:1px solid rgba(255,255,255,.02);font-family:'SF Mono',Consolas,monospace;font-variant-numeric:tabular-nums}
        td:first-child{text-align:center;color:var(--muted);font-size:10px}
        .table-card.buy td:nth-child(2){color:var(--buy);font-weight:600}
        .table-card.sell td:nth-child(2){color:var(--sell);font-weight:600}
        tr{transition:background .1s}
        tr:hover{background:rgba(255,255,255,.03)}
        
        .depth-cell{position:relative}
        .depth-bar{position:absolute;top:0;bottom:0;right:0;opacity:.15;pointer-events:none}
        .table-card.buy .depth-bar{background:var(--buy)}
        .table-card.sell .depth-bar{background:var(--sell)}
        
        .load-more-row{text-align:center;padding:10px}
        .load-more-row button{background:rgba(0,212,255,.1);border:1px solid var(--accent);color:var(--accent);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:11px;transition:all .2s}
        .load-more-row button:hover{background:rgba(0,212,255,.2)}
        
        .summary{padding:10px 15px;background:rgba(0,0,0,.2);font-size:11px}
        .summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .summary-item{text-align:center}
        .summary-label{color:var(--muted);font-size:9px;text-transform:uppercase}
        .summary-value{font-weight:700;margin-top:2px;font-family:'SF Mono',Consolas,monospace}
        .table-card.buy .summary-value{color:var(--buy)}
        .table-card.sell .summary-value{color:var(--sell)}
        
        .footer{text-align:center;padding:15px;color:var(--muted);font-size:10px}
        .footer a{color:var(--accent);text-decoration:none}
        .perf-stats{display:flex;justify-content:center;gap:20px;margin-top:5px;font-family:'SF Mono',Consolas,monospace}
        .perf-stat{display:flex;align-items:center;gap:4px}
        .perf-stat.fast{color:var(--buy)}
        .perf-stat.medium{color:var(--warning)}
        .perf-stat.slow{color:var(--sell)}
        
        .skeleton{background:linear-gradient(90deg,var(--bg) 25%,var(--border) 50%,var(--bg) 75%);background-size:200% 100%;animation:shimmer .8s infinite linear}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .skeleton-row{height:24px;margin:3px 10px;border-radius:3px}
        
        .error-box{text-align:center;padding:30px;color:var(--sell)}
        .error-box button{margin-top:10px}
        
        .search-option.keyboard-focus{background:rgba(0,212,255,.2);outline:1px solid var(--accent)}
        
        .data-info{font-size:10px;color:var(--muted);text-align:center;padding:5px;background:rgba(0,0,0,.2);border-top:1px solid var(--border)}
        
        @media(max-width:768px){
            .tables{grid-template-columns:1fr}
            .price-bar{grid-template-columns:1fr 1fr;gap:8px}
            .price-item:first-child,.price-item:last-child{text-align:center}
            .price-item.spread-item{grid-column:span 2}
            .select-wrap{min-width:100%;max-width:100%}
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            ‚ö° HYPER ORDER BOOK
            <span class="badge">v3.3</span>
        </div>
        <div class="speed-indicator">
            <span><span class="dot" id="wsStatus"></span> <span id="wsText">Menghubungkan...</span></span>
            <span>üöÄ <span id="latency">--</span>ms</span>
            <span>üìä <span id="rps">0</span> req/s</span>
        </div>
    </div>
    
    <div class="controls">
        <div class="select-wrap" id="selectWrap">
            <div class="select-display" id="selectDisplay">
                <span class="select-icon">ü™ô</span>
                <span class="select-text" id="selectText">Memuat...</span>
                <span class="select-pair" id="selectPair">---</span>
            </div>
            <div class="search-dropdown" id="searchDropdown">
                <div class="search-input-wrap">
                    <input type="text" class="search-input" id="searchInput" placeholder="Ketik untuk mencari koin..." autocomplete="off">
                </div>
                <div class="search-options" id="searchOptions"></div>
                <div class="no-result" id="noResult">üòï Tidak ditemukan</div>
                <div class="search-stats">
                    <span id="searchCount">0 koin</span>
                    <span>‚Üë‚Üì Navigasi ‚Ä¢ Enter Pilih ‚Ä¢ Esc Tutup</span>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" id="refreshBtn">‚ö° REFRESH</button>
        <span class="status-badge" id="status"></span>
    </div>
    
    <div class="price-bar" id="priceBar" style="display:none">
        <div class="price-item">
            <div class="price-label">Harga Beli Tertinggi</div>
            <div class="price-value buy" id="bestBid">-</div>
        </div>
        <div class="price-item spread-item">
            <div class="price-label">Selisih (Spread)</div>
            <div class="price-value spread" id="spread">-</div>
        </div>
        <div class="price-item">
            <div class="price-label">Harga Jual Terendah</div>
            <div class="price-value sell" id="bestAsk">-</div>
        </div>
    </div>
    
    <div class="tables">
        <div class="table-card buy">
            <div class="table-header">
                <span class="table-title">üìà ORDER BELI</span>
                <div class="header-right">
                    <span class="count-badge" id="buyCount">0</span>
                </div>
            </div>
            <div class="table-scroll gpu" id="buyScroll">
                <table>
                    <thead><tr><th>No</th><th>Harga (Rp)</th><th>Jumlah</th><th>Total (Rp)</th></tr></thead>
                    <tbody id="buyBody"></tbody>
                </table>
            </div>
            <div class="data-info" id="buyInfo">Menampilkan 0 dari 0 order</div>
            <div class="summary">
                <div class="summary-grid">
                    <div class="summary-item"><div class="summary-label">Total Order</div><div class="summary-value" id="buyOrders">-</div></div>
                    <div class="summary-item"><div class="summary-label">Total Volume</div><div class="summary-value" id="buyVol">-</div></div>
                    <div class="summary-item"><div class="summary-label">Total Nilai</div><div class="summary-value" id="buyVal">-</div></div>
                </div>
            </div>
        </div>
        
        <div class="table-card sell">
            <div class="table-header">
                <span class="table-title">üìâ ORDER JUAL</span>
                <div class="header-right">
                    <span class="count-badge" id="sellCount">0</span>
                </div>
            </div>
            <div class="table-scroll gpu" id="sellScroll">
                <table>
                    <thead><tr><th>No</th><th>Harga (Rp)</th><th>Jumlah</th><th>Total (Rp)</th></tr></thead>
                    <tbody id="sellBody"></tbody>
                </table>
            </div>
            <div class="data-info" id="sellInfo">Menampilkan 0 dari 0 order</div>
            <div class="summary">
                <div class="summary-grid">
                    <div class="summary-item"><div class="summary-label">Total Order</div><div class="summary-value" id="sellOrders">-</div></div>
                    <div class="summary-item"><div class="summary-label">Total Volume</div><div class="summary-value" id="sellVol">-</div></div>
                    <div class="summary-item"><div class="summary-label">Total Nilai</div><div class="summary-value" id="sellVal">-</div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div>Terakhir Diperbarui: <span id="lastUpdate">-</span> | Sumber: <a href="https://indodax.com" target="_blank">Indodax</a></div>
        <div class="perf-stats">
            <span class="perf-stat" id="fetchTime">‚è±Ô∏è Ambil: --ms</span>
            <span class="perf-stat" id="renderTime">üé® Render: --ms</span>
            <span class="perf-stat" id="totalTime">‚ö° Total: --ms</span>
        </div>
    </div>

<script>
// ============================================
// üöÄ HYPER SPEED ENGINE v3.3 - FULL INDONESIA
// ============================================

const CONFIG = {
    PROXIES: [
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
    ],
    TIMEOUT: 5000,
    INITIAL_ROWS: 50, // Awalnya tampilkan 50
    CACHE_TTL: 3600000
};

// Crypto icons
const CRYPTO_ICONS = {
    btc:'‚Çø',eth:'‚ü†',doge:'üêï',shib:'üêï',xrp:'‚úï',bnb:'‚¨°',sol:'‚óé',ada:'‚Ç≥',
    dot:'‚óè',matic:'‚¨°',link:'‚¨°',uni:'ü¶Ñ',atom:'‚öõ',ltc:'≈Å',etc:'‚ü†',
    trx:'‚óà',xlm:'‚ú¶',vet:'‚úî',fil:'‚®é',theta:'œë',icp:'‚àû',aave:'üëª',
    usdt:'‚ÇÆ',usdc:'$',busd:'$',default:'ü™ô'
};

function getCryptoIcon(id) {
    const symbol = id.replace('idr', '').toLowerCase();
    return CRYPTO_ICONS[symbol] || CRYPTO_ICONS.default;
}

// ============================================
// üíæ CACHE
// ============================================
const Cache = {
    data: new Map(),
    get(key) {
        const item = this.data.get(key);
        if (!item || Date.now() > item.exp) {
            this.data.delete(key);
            return null;
        }
        return item.value;
    },
    set(key, value, ttl = CONFIG.CACHE_TTL) {
        this.data.set(key, { value, exp: Date.now() + ttl });
    }
};

// ============================================
// ‚ö° FETCHER
// ============================================
const Fetcher = {
    stats: CONFIG.PROXIES.map(() => ({ time: 1000, fails: 0 })),
    
    async fetch(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
        
        const sorted = CONFIG.PROXIES
            .map((fn, i) => ({ fn, i, score: this.stats[i].time + this.stats[i].fails * 500 }))
            .sort((a, b) => a.score - b.score);
        
        let lastError;
        
        for (const { fn, i } of sorted) {
            try {
                const start = performance.now();
                const res = await fetch(fn(url), { 
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                const elapsed = performance.now() - start;
                
                clearTimeout(timeoutId);
                this.stats[i].time = this.stats[i].time * 0.7 + elapsed * 0.3;
                this.stats[i].fails = Math.max(0, this.stats[i].fails - 1);
                
                return { data, elapsed, proxy: i };
            } catch (e) {
                this.stats[i].fails++;
                lastError = e;
            }
        }
        
        clearTimeout(timeoutId);
        throw lastError || new Error('Semua proxy gagal');
    }
};

// ============================================
// üé® RENDERER
// ============================================
const Renderer = {
    // Store full data for "load more"
    buyData: [],
    sellData: [],
    buyShown: 0,
    sellShown: 0,
    coinName: '',
    
    // Format harga dengan Rp
    formatPrice(n) {
        if (n >= 1) return 'Rp ' + n.toLocaleString('id-ID');
        if (n >= 0.0001) return 'Rp ' + n.toFixed(4);
        return 'Rp ' + n.toFixed(8);
    },
    
    // Format jumlah koin
    formatAmount(n) {
        if (n >= 1e9) return (n / 1e9).toFixed(2) + ' M';
        if (n >= 1e6) return (n / 1e6).toFixed(2) + ' Jt';
        if (n >= 1e3) return (n / 1e3).toFixed(2) + ' Rb';
        if (n >= 1) return n.toFixed(4);
        if (n >= 0.0001) return n.toFixed(4);
        return n.toFixed(8);
    },
    
    // Format total dalam Rupiah
    formatTotal(n) {
        if (n >= 1e12) return 'Rp ' + (n / 1e12).toFixed(2) + ' T';
        if (n >= 1e9) return 'Rp ' + (n / 1e9).toFixed(2) + ' M';
        if (n >= 1e6) return 'Rp ' + (n / 1e6).toFixed(2) + ' Jt';
        if (n >= 1e3) return 'Rp ' + (n / 1e3).toFixed(0) + ' Rb';
        return 'Rp ' + n.toLocaleString('id-ID');
    },
    
    // Format nilai summary
    formatValue(n) {
        if (n >= 1e12) return 'Rp ' + (n / 1e12).toFixed(2) + ' Triliun';
        if (n >= 1e9) return 'Rp ' + (n / 1e9).toFixed(2) + ' Miliar';
        if (n >= 1e6) return 'Rp ' + (n / 1e6).toFixed(2) + ' Juta';
        return 'Rp ' + Math.round(n).toLocaleString('id-ID');
    },
    
    renderTable(type, data, coinName, showCount = CONFIG.INITIAL_ROWS) {
        // Store data for load more
        if (type === 'buy') {
            this.buyData = data;
            this.buyShown = showCount;
        } else {
            this.sellData = data;
            this.sellShown = showCount;
        }
        this.coinName = coinName;
        
        const tbody = document.getElementById(type + 'Body');
        const display = data.slice(0, showCount);
        const hasMore = data.length > showCount;
        
        // Calculate totals and max depth
        let totalVol = 0, totalVal = 0;
        const totals = [];
        
        for (const row of data) {
            const p = +row[0], a = +row[1], t = p * a;
            totalVol += a;
            totalVal += t;
            totals.push(t);
        }
        
        const maxDepth = Math.max(...totals.slice(0, 20)) || 1;
        
        // Build rows HTML
        let html = display.map((row, i) => {
            const p = +row[0], a = +row[1], t = p * a;
            const depthPct = Math.min((t / maxDepth) * 100, 100);
            
            return `<tr>
                <td>${i + 1}</td>
                <td>${this.formatPrice(p)}</td>
                <td>${this.formatAmount(a)}</td>
                <td class="depth-cell">
                    <span class="depth-bar" style="width:${depthPct}%"></span>
                    ${this.formatTotal(t)}
                </td>
            </tr>`;
        }).join('');
        
        // Add "load more" button if there's more data
        if (hasMore) {
            const remaining = data.length - showCount;
            html += `<tr class="load-more-row">
                <td colspan="4">
                    <button onclick="Renderer.loadMore('${type}')">
                        üì• Tampilkan ${Math.min(remaining, 50)} lagi (${remaining} tersisa)
                    </button>
                </td>
            </tr>`;
        }
        
        tbody.innerHTML = html;
        
        // Update info
        document.getElementById(type + 'Info').textContent = 
            `Menampilkan ${Math.min(showCount, data.length)} dari ${data.length} order`;
        
        // Update counts and summary
        document.getElementById(type + 'Count').textContent = data.length;
        document.getElementById(type + 'Orders').textContent = data.length.toLocaleString('id-ID');
        document.getElementById(type + 'Vol').textContent = this.formatAmount(totalVol) + ' ' + coinName;
        document.getElementById(type + 'Val').textContent = this.formatValue(totalVal);
    },
    
    loadMore(type) {
        if (type === 'buy') {
            this.buyShown += 50;
            this.renderTable('buy', this.buyData, this.coinName, this.buyShown);
        } else {
            this.sellShown += 50;
            this.renderTable('sell', this.sellData, this.coinName, this.sellShown);
        }
        
        // Scroll to bottom of new content
        const scroll = document.getElementById(type + 'Scroll');
        scroll.scrollTop = scroll.scrollHeight;
    },
    
    showSkeleton(type) {
        document.getElementById(type + 'Body').innerHTML = Array(10).fill(
            '<tr><td colspan="4"><div class="skeleton skeleton-row"></div></td></tr>'
        ).join('');
        document.getElementById(type + 'Info').textContent = 'Memuat data...';
    },
    
    showError(type, message) {
        document.getElementById(type + 'Body').innerHTML = `<tr><td colspan="4" class="error-box">
            ‚ùå ${message}<br>
            <button class="btn btn-primary" onclick="App.refresh()">üîÑ Coba Lagi</button>
        </td></tr>`;
        document.getElementById(type + 'Info').textContent = 'Gagal memuat data';
    }
};

// ============================================
// üîç SEARCH DROPDOWN
// ============================================
const SearchDropdown = {
    isOpen: false,
    keyboardIndex: -1,
    filteredOptions: [],
    el: {},
    
    init() {
        this.el = {
            wrap: document.getElementById('selectWrap'),
            display: document.getElementById('selectDisplay'),
            text: document.getElementById('selectText'),
            pair: document.getElementById('selectPair'),
            dropdown: document.getElementById('searchDropdown'),
            input: document.getElementById('searchInput'),
            options: document.getElementById('searchOptions'),
            noResult: document.getElementById('noResult'),
            count: document.getElementById('searchCount')
        };
        
        this.el.display.addEventListener('click', () => this.toggle());
        this.el.input.addEventListener('input', () => this.filter());
        this.el.input.addEventListener('keydown', (e) => this.handleKeyboard(e));
        
        document.addEventListener('click', (e) => {
            if (!this.el.wrap.contains(e.target)) this.close();
        });
        
        this.el.options.addEventListener('click', (e) => {
            const option = e.target.closest('.search-option');
            if (option) this.select(option.dataset.id);
        });
    },
    
    buildOptions(pairs, currentId) {
        this.el.options.innerHTML = pairs.map(p => `
            <div class="search-option${p.id === currentId ? ' selected' : ''}" data-id="${p.id}">
                <span class="option-icon">${getCryptoIcon(p.id)}</span>
                <div class="option-info">
                    <div class="option-name">${p.description}</div>
                    <div class="option-pair">${p.id.toUpperCase()}</div>
                </div>
                <span class="option-check">‚úì</span>
            </div>
        `).join('');
        
        this.el.count.textContent = `${pairs.length} koin tersedia`;
        this.filteredOptions = [...this.el.options.querySelectorAll('.search-option')];
    },
    
    updateDisplay(pair) {
        if (pair) {
            this.el.text.textContent = pair.description;
            this.el.pair.textContent = pair.id.toUpperCase();
        }
    },
    
    toggle() {
        this.isOpen ? this.close() : this.open();
    },
    
    open() {
        this.isOpen = true;
        this.el.display.classList.add('open');
        this.el.dropdown.classList.add('show');
        this.el.input.value = '';
        this.filter();
        this.el.input.focus();
        this.keyboardIndex = -1;
    },
    
    close() {
        this.isOpen = false;
        this.el.display.classList.remove('open');
        this.el.dropdown.classList.remove('show');
    },
    
    filter() {
        const query = this.el.input.value.toLowerCase().trim();
        let visibleCount = 0;
        this.filteredOptions = [];
        
        this.el.options.querySelectorAll('.search-option').forEach(opt => {
            const name = opt.querySelector('.option-name').textContent.toLowerCase();
            const pair = opt.querySelector('.option-pair').textContent.toLowerCase();
            const match = name.includes(query) || pair.includes(query);
            
            opt.classList.toggle('hidden', !match);
            if (match) {
                visibleCount++;
                this.filteredOptions.push(opt);
            }
        });
        
        this.el.noResult.classList.toggle('show', visibleCount === 0);
        this.el.count.textContent = `${visibleCount} koin ditemukan`;
        this.keyboardIndex = -1;
    },
    
    handleKeyboard(e) {
        const opts = this.filteredOptions;
        
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.keyboardIndex = Math.min(this.keyboardIndex + 1, opts.length - 1);
                this.updateKeyboardFocus();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.keyboardIndex = Math.max(this.keyboardIndex - 1, 0);
                this.updateKeyboardFocus();
                break;
            case 'Enter':
                e.preventDefault();
                if (this.keyboardIndex >= 0 && opts[this.keyboardIndex]) {
                    this.select(opts[this.keyboardIndex].dataset.id);
                }
                break;
            case 'Escape':
                e.preventDefault();
                this.close();
                break;
        }
    },
    
    updateKeyboardFocus() {
        this.el.options.querySelectorAll('.keyboard-focus').forEach(el => el.classList.remove('keyboard-focus'));
        if (this.keyboardIndex >= 0 && this.filteredOptions[this.keyboardIndex]) {
            const opt = this.filteredOptions[this.keyboardIndex];
            opt.classList.add('keyboard-focus');
            opt.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    },
    
    select(id) {
        this.el.options.querySelectorAll('.search-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.id === id);
        });
        this.close();
        App.loadOrderBook(id);
    }
};

// ============================================
// üéÆ MAIN APP
// ============================================
const App = {
    pairs: [],
    currentPair: '',
    coinName: '',
    isLoading: false,
    requestCount: 0,
    startTime: Date.now(),
    el: {},
    
    async init() {
        this.el = {
            refreshBtn: document.getElementById('refreshBtn'),
            status: document.getElementById('status'),
            wsStatus: document.getElementById('wsStatus'),
            wsText: document.getElementById('wsText'),
            latency: document.getElementById('latency'),
            rps: document.getElementById('rps'),
            priceBar: document.getElementById('priceBar'),
            bestBid: document.getElementById('bestBid'),
            bestAsk: document.getElementById('bestAsk'),
            spread: document.getElementById('spread'),
            lastUpdate: document.getElementById('lastUpdate'),
            fetchTime: document.getElementById('fetchTime'),
            renderTime: document.getElementById('renderTime'),
            totalTime: document.getElementById('totalTime')
        };
        
        SearchDropdown.init();
        
        Renderer.showSkeleton('buy');
        Renderer.showSkeleton('sell');
        this.setStatus('Memulai...', 'loading');
        
        // RPS Counter
        setInterval(() => {
            const elapsed = (Date.now() - this.startTime) / 1000;
            this.el.rps.textContent = elapsed > 0 ? (this.requestCount / Math.max(elapsed, 1)).toFixed(1) : '0';
        }, 1000);
        
        try {
            await this.loadPairs();
            await this.loadOrderBook(this.currentPair);
            
            this.el.wsStatus.className = 'dot';
            this.el.wsText.textContent = 'Terhubung';
        } catch (e) {
            this.setStatus('‚ùå ' + e.message, 'error');
            this.el.wsStatus.className = 'dot error';
            this.el.wsText.textContent = 'Gagal';
        }
        
        this.el.refreshBtn.addEventListener('click', () => this.refresh());
    },
    
    async loadPairs() {
        let pairs = Cache.get('pairs');
        
        if (!pairs) {
            this.setStatus('Memuat daftar koin...', 'loading');
            const result = await Fetcher.fetch('https://indodax.com/api/pairs');
            pairs = result.data.sort((a, b) => a.description.localeCompare(b.description));
            Cache.set('pairs', pairs);
        }
        
        this.pairs = pairs;
        
        const btc = pairs.find(p => p.id === 'btcidr');
        this.currentPair = btc ? btc.id : pairs[0]?.id || 'btcidr';
        
        SearchDropdown.buildOptions(pairs, this.currentPair);
        SearchDropdown.updateDisplay(pairs.find(p => p.id === this.currentPair));
    },
    
    async loadOrderBook(pairId) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.currentPair = pairId;
        
        const pair = this.pairs.find(p => p.id === pairId);
        this.coinName = pair ? pair.description.split('/')[0].trim() : pairId.replace('idr', '').toUpperCase();
        
        SearchDropdown.updateDisplay(pair);
        
        this.el.refreshBtn.disabled = true;
        this.el.wsStatus.className = 'dot slow';
        this.setStatus('Memuat...', 'loading');
        
        Renderer.showSkeleton('buy');
        Renderer.showSkeleton('sell');
        
        const totalStart = performance.now();
        
        try {
            const fetchStart = performance.now();
            const result = await Fetcher.fetch(`https://indodax.com/api/depth/${pairId}`);
            const fetchTime = performance.now() - fetchStart;
            
            this.requestCount++;
            
            // Data dari API (tidak ada limit dari kode kita!)
            const buyData = result.data.buy || [];
            const sellData = result.data.sell || [];
            
            console.log(`[Data] ${pairId}: ${buyData.length} beli, ${sellData.length} jual`);
            
            this.el.latency.textContent = Math.round(result.elapsed);
            this.el.fetchTime.textContent = `‚è±Ô∏è Ambil: ${Math.round(fetchTime)}ms`;
            this.el.fetchTime.className = 'perf-stat ' + this.getSpeedClass(fetchTime);
            
            if (buyData.length && sellData.length) {
                const bestBid = +buyData[0][0];
                const bestAsk = +sellData[0][0];
                const spread = bestAsk - bestBid;
                const spreadPct = ((spread / bestAsk) * 100).toFixed(3);
                
                this.el.bestBid.textContent = 'Rp ' + bestBid.toLocaleString('id-ID');
                this.el.bestAsk.textContent = 'Rp ' + bestAsk.toLocaleString('id-ID');
                this.el.spread.textContent = `Rp ${spread.toLocaleString('id-ID')} (${spreadPct}%)`;
                this.el.priceBar.style.display = 'grid';
            }
            
            const renderStart = performance.now();
            
            // Render dengan initial rows, ada tombol load more
            Renderer.renderTable('buy', buyData, this.coinName, CONFIG.INITIAL_ROWS);
            Renderer.renderTable('sell', sellData, this.coinName, CONFIG.INITIAL_ROWS);
            
            const renderTime = performance.now() - renderStart;
            const totalTime = performance.now() - totalStart;
            
            this.el.renderTime.textContent = `üé® Render: ${Math.round(renderTime)}ms`;
            this.el.renderTime.className = 'perf-stat ' + this.getSpeedClass(renderTime);
            
            this.el.totalTime.textContent = `‚ö° Total: ${Math.round(totalTime)}ms`;
            this.el.totalTime.className = 'perf-stat ' + this.getSpeedClass(totalTime);
            
            this.el.lastUpdate.textContent = new Date().toLocaleTimeString('id-ID') + 
                ` | ${pairId.toUpperCase()} | ${buyData.length + sellData.length} order`;
            
            this.setStatus('‚úì Siap', 'success');
            this.el.wsStatus.className = 'dot';
            
        } catch (e) {
            this.setStatus('‚ùå ' + e.message, 'error');
            this.el.wsStatus.className = 'dot error';
            
            Renderer.showError('buy', e.message);
            Renderer.showError('sell', e.message);
        }
        
        this.el.refreshBtn.disabled = false;
        this.isLoading = false;
    },
    
    refresh() {
        if (this.currentPair) this.loadOrderBook(this.currentPair);
    },
    
    getSpeedClass(ms) {
        if (ms < 100) return 'fast';
        if (ms < 500) return 'medium';
        return 'slow';
    },
    
    setStatus(text, type) {
        this.el.status.className = 'status-badge ' + type;
        this.el.status.innerHTML = type === 'loading' ? `<span class="spinner"></span> ${text}` : text;
        
        if (type === 'success') {
            setTimeout(() => {
                this.el.status.textContent = '';
                this.el.status.className = 'status-badge';
            }, 2000);
        }
    }
};

// ============================================
// üöÄ START
// ============================================
document.addEventListener('DOMContentLoaded', () => App.init());
window.App = App;
window.Renderer = Renderer;
</script>
</body>
</html>
